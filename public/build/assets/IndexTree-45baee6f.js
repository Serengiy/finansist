import{r as D,k as de,j as oe,P as A,m as J,N as ce,y as me,o as T,c as I,w as x,l as G,b,a as p,e as U,f as fe,d as ye,x as O,p as K,z as ge,F as pe,A as ve,t as Q,v as he,q as De}from"./app-90bf6a79.js";import{Q as S}from"./QSelect-4ea1f147.js";import{Q as be}from"./QForm-b0f9c6cf.js";import{Q as we}from"./QPage-3662eeea.js";import{s as Ne,a as X}from"./index-5d5d1fa5.js";import{t as F,c as w,p as Te,s as k,m as te,a as ae,o as $,h as xe}from"./format-04e7afb3.js";import{s as _,b as ze}from"./startOfQuarter-72f9bb24.js";function Ie(r,e,t){const a=F(r,t==null?void 0:t.in);if(isNaN(e))return w((t==null?void 0:t.in)||r,NaN);if(!e)return a;const l=a.getDate(),n=w((t==null?void 0:t.in)||r,a.getTime());n.setMonth(a.getMonth()+e+1,0);const u=n.getDate();return l>=u?n:(a.setFullYear(n.getFullYear(),n.getMonth(),l),a)}function ke(r,e,t){return Ie(r,e*3,t)}function M(r,e){const[t,a]=Te(r,e.start,e.end);return{start:t,end:a}}function _e(r,e){const{start:t,end:a}=M(e==null?void 0:e.in,r);let l=+t>+a;const n=l?+t:+a,u=l?a:t;u.setHours(0,0,0,0);let i=(e==null?void 0:e.step)??1;if(!i)return[];i<0&&(i=-i,l=!l);const d=[];for(;+u<=n;)d.push(w(t,u)),u.setDate(u.getDate()+i),u.setHours(0,0,0,0);return l?d.reverse():d}function Ce(r,e){const{start:t,end:a}=M(e==null?void 0:e.in,r);let l=+t>+a;const n=l?+t:+a,u=l?a:t;u.setHours(0,0,0,0),u.setDate(1);let i=(e==null?void 0:e.step)??1;if(!i)return[];i<0&&(i=-i,l=!l);const d=[];for(;+u<=n;)d.push(w(t,u)),u.setMonth(u.getMonth()+i);return l?d.reverse():d}function Fe(r,e){const{start:t,end:a}=M(e==null?void 0:e.in,r);let l=+t>+a;const n=l?+_(t):+_(a);let u=l?_(a):_(t),i=(e==null?void 0:e.step)??1;if(!i)return[];i<0&&(i=-i,l=!l);const d=[];for(;+u<=n;)d.push(w(t,u)),u=ke(u,i);return l?d.reverse():d}function Me(r,e){const{start:t,end:a}=M(e==null?void 0:e.in,r);let l=+t>+a;const n=l?k(a,e):k(t,e),u=l?k(t,e):k(a,e);n.setHours(15),u.setHours(15);const i=+u.getTime();let d=n,m=(e==null?void 0:e.step)??1;if(!m)return[];m<0&&(m=-m,l=!l);const v=[];for(;+d<=i;)d.setHours(0),v.push(w(t,d)),d=ze(d,m),d.setHours(15);return l?v.reverse():v}function qe(r,e){return F(r,e==null?void 0:e.in).getFullYear()}function ee(r,e){const t=()=>w(e==null?void 0:e.in,NaN),a=(e==null?void 0:e.additionalDigits)??2,l=Qe(r);let n;if(l.date){const m=Se(l.date,a);n=$e(m.restDateString,m.year)}if(!n||isNaN(+n))return t();const u=+n;let i=0,d;if(l.time&&(i=Be(l.time),isNaN(i)))return t();if(l.timezone){if(d=We(l.timezone),isNaN(d))return t()}else{const m=new Date(u+i),v=F(0,e==null?void 0:e.in);return v.setFullYear(m.getUTCFullYear(),m.getUTCMonth(),m.getUTCDate()),v.setHours(m.getUTCHours(),m.getUTCMinutes(),m.getUTCSeconds(),m.getUTCMilliseconds()),v}return F(u+i+d,e==null?void 0:e.in)}const C={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},Ve=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,Ue=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Oe=/^([+-])(\d{2})(?::?(\d{2}))?$/;function Qe(r){const e={},t=r.split(C.dateTimeDelimiter);let a;if(t.length>2)return e;if(/:/.test(t[0])?a=t[0]:(e.date=t[0],a=t[1],C.timeZoneDelimiter.test(e.date)&&(e.date=r.split(C.timeZoneDelimiter)[0],a=r.substr(e.date.length,r.length))),a){const l=C.timezone.exec(a);l?(e.time=a.replace(l[1],""),e.timezone=l[1]):e.time=a}return e}function Se(r,e){const t=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+e)+"})|(\\d{2}|[+-]\\d{"+(2+e)+"})$)"),a=r.match(t);if(!a)return{year:NaN,restDateString:""};const l=a[1]?parseInt(a[1]):null,n=a[2]?parseInt(a[2]):null;return{year:n===null?l:n*100,restDateString:r.slice((a[1]||a[2]).length)}}function $e(r,e){if(e===null)return new Date(NaN);const t=r.match(Ve);if(!t)return new Date(NaN);const a=!!t[4],l=z(t[1]),n=z(t[2])-1,u=z(t[3]),i=z(t[4]),d=z(t[5])-1;if(a)return je(e,i,d)?Ye(e,i,d):new Date(NaN);{const m=new Date(0);return!Re(e,n,u)||!Ze(e,l)?new Date(NaN):(m.setUTCFullYear(e,n,Math.max(l,u)),m)}}function z(r){return r?parseInt(r):1}function Be(r){const e=r.match(Ue);if(!e)return NaN;const t=B(e[1]),a=B(e[2]),l=B(e[3]);return Le(t,a,l)?t*te+a*ae+l*1e3:NaN}function B(r){return r&&parseFloat(r.replace(",","."))||0}function We(r){if(r==="Z")return 0;const e=r.match(Oe);if(!e)return 0;const t=e[1]==="+"?-1:1,a=parseInt(e[2]),l=e[3]&&parseInt(e[3])||0;return Ee(a,l)?t*(a*te+l*ae):NaN}function Ye(r,e,t){const a=new Date(0);a.setUTCFullYear(r,0,4);const l=a.getUTCDay()||7,n=(e-1)*7+t+1-l;return a.setUTCDate(a.getUTCDate()+n),a}const He=[31,null,31,30,31,30,31,31,30,31,30,31];function re(r){return r%400===0||r%4===0&&r%100!==0}function Re(r,e,t){return e>=0&&e<=11&&t>=1&&t<=(He[e]||(re(r)?29:28))}function Ze(r,e){return e>=1&&e<=(re(r)?366:365)}function je(r,e,t){return e>=1&&e<=53&&t>=0&&t<=6}function Le(r,e,t){return r===24?e===0&&t===0:t>=0&&t<60&&e>=0&&e<60&&r>=0&&r<25}function Ee(r,e){return e>=0&&e<=59}const Pe={class:"bg-white q-ma-sm q-pa-sm rounded-borders"},Ae={class:"row"},Je={class:"row q-mt-md"},Ge={class:"text-center full-width"},Ke={class:"q-pa-xs flex justify-between items-center full-width"},Xe={key:1},et={class:"q-ml-md"},it={__name:"IndexTree",setup(r){const e=D([]),t=D([]),a=D(!1),l=D([]),n=D([]),u=D(!1),i=D([]),d={daily:"dd-MM-yyyy",weekly:"W-oooo",monthly:"MM-yyyy",quarterly:"Q-yyyy"};function m(o){return{key:o.id,data:{name:o.name,categoryType:o.category_type,...Object.fromEntries(t.value.map(c=>{var g;return[`date-${c}`,(g=o.totals)==null?void 0:g[c]]}))},children:o.children?o.children.map(c=>m(c)):[]}}const v=()=>{const o=new Date;return o.setDate(1),o.toISOString().split("T")[0]},le=()=>{const o=new Date;return o.setMonth(o.getMonth()+1),o.setDate(0),o.toISOString().split("T")[0]},se=o=>new Intl.NumberFormat("ru-RU",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}).format(o),f=D({groupBy:null,dateFrom:v(),dateTo:le(),type:null,purposeQuery:"",category:null,pizzerias:[]}),ne=()=>{q()};de(()=>{q()}),oe(()=>f.value.groupBy,()=>{q()});const ue=async(o,c,g)=>{if(o.length>4){u.value=!0;try{const s=await J.get("/api/contractors",{params:{q:o}});n.value=s.data.data,c(()=>n.value)}catch(s){console.log(s),g()}finally{u.value=!1}}else n.value=[],c(()=>n.value)},ie=(o,c,g)=>{switch(g){case"weekly":return Me({start:o,end:c},{weekStartsOn:1}).map(s=>`${xe(s)}-${qe(s)}`);case"monthly":return Ce({start:o,end:c}).map(s=>$(s,d.monthly));case"quarterly":return Fe({start:o,end:c}).map(s=>$(s,d.quarterly));case"daily":default:return _e({start:o,end:c}).map(s=>$(s,d.daily))}},q=async()=>{var o,c;A.show({message:"Загрузка..."});try{const g=ee(f.value.dateFrom),s=ee(f.value.dateTo),V=((o=f.value.groupBy)==null?void 0:o.value)||"daily";t.value=ie(g,s,V);const y=await J.get("/api/categories/tree",{params:{startDate:f.value.dateFrom,endDate:f.value.dateTo,groupBy:(c=f.value.groupBy)==null?void 0:c.value,pizzeriaIds:f.value.pizzerias.map(h=>h.id),contractorIds:i.value.map(h=>h.id),purposeQuery:f.value.purposeQuery}});console.log(y.data),l.value=y.data.pizzerias,e.value=y.data.categories.map(h=>m(h))}catch(g){console.log(g),ce.create({message:"Fetching failed",color:"red"})}finally{A.hide()}};return(o,c)=>{const g=me("router-link");return e.value.length?(T(),I(we,{key:0,class:"bg-grey-2"},{default:x(()=>[b("div",Pe,[p(be,{onSubmit:ye(ne,["prevent"]),class:"items-center q-pa-md bg-grey-2 rounded-borders"},{default:x(()=>[b("div",Ae,[p(U,{class:"col-2 q-px-sm",clearable:"",dense:"",outlined:"",filled:"",modelValue:f.value.dateFrom,"onUpdate:modelValue":c[0]||(c[0]=s=>f.value.dateFrom=s),label:"Дата начала",type:"date"},null,8,["modelValue"]),p(U,{class:"col-2 q-px-sm",dense:"",clearable:"",outlined:"",filled:"",modelValue:f.value.dateTo,"onUpdate:modelValue":c[1]||(c[1]=s=>f.value.dateTo=s),label:"Дата окончания",type:"date"},null,8,["modelValue"]),p(S,{class:"col-3 q-px-sm",dense:"",outlined:"",filled:"",label:"Группировать по",modelValue:f.value.groupBy,"onUpdate:modelValue":c[2]||(c[2]=s=>f.value.groupBy=s),options:[{label:"Дням",value:"daily"},{label:"Неделям",value:"weekly"},{label:"Месяцам",value:"monthly"},{label:"Кварталам",value:"quarterly"}]},null,8,["modelValue"]),p(S,{class:"col-3 q-px-sm",dense:"",outlined:"",filled:"",label:"Пиццерия",multiple:"","use-chips":"",modelValue:f.value.pizzerias,"onUpdate:modelValue":c[3]||(c[3]=s=>f.value.pizzerias=s),options:l.value,clearable:"","option-label":"name"},null,8,["modelValue","options"]),p(S,{class:"col-6 q-mt-sm",dense:"",outlined:"",filled:"",label:"Контрагенты (получатели)",modelValue:i.value,"onUpdate:modelValue":c[4]||(c[4]=s=>i.value=s),options:n.value,"use-input":"",multiple:"",clearable:"","option-label":"name",onFilter:ue,loading:u.value},null,8,["modelValue","options","loading"]),p(U,{class:"col-6 q-mt-sm justify-center q-px-md",dense:"",outlined:"",filled:"",clearable:"",label:"Назначение платежа",modelValue:f.value.purposeQuery,"onUpdate:modelValue":c[5]||(c[5]=s=>f.value.purposeQuery=s),"option-label":"name"},null,8,["modelValue"])]),b("div",Je,[p(fe,{class:"text-right",dense:"",size:"sm",type:"submit",label:"Применить фильтры",color:"primary"})])]),_:1}),p(O(Ne),{class:"custom-tree-table q-mt-md q-px-sm",value:e.value,tableStyle:"min-width: 60rem; border-collapse: separate; border-spacing: 0 0.5rem "},{default:x(()=>[p(O(X),{field:"name",header:"Категория",expander:"",style:{width:"20%","font-weight":"bold"}}),(T(!0),K(pe,null,ge(t.value,(s,V)=>(T(),I(O(X),{key:V,field:`date-${s}`,style:{"min-width":"180px","padding-right":"1rem"}},{header:x(({node:y})=>[b("span",Ge,Q(s),1)]),body:x(({node:y})=>{var h,W,Y,H,R,Z,j,L,E,P;return[b("div",Ke,[b("span",{class:he({"text-red":(W=(h=y.data[`date-${s}`])==null?void 0:h.sum)==null?void 0:W.toString().startsWith("-"),"text-green":((Y=y.data[`date-${s}`])==null?void 0:Y.sum)>0,"":((H=y.data[`date-${s}`])==null?void 0:H.sum)===0})},[(R=y.data[`date-${s}`])!=null&&R.sum?(T(),I(g,{key:0,target:"_blank",to:{name:"OperationIndex",query:{parentCategoryId:y==null?void 0:y.key,date:s,groupBy:((j=(Z=f.value)==null?void 0:Z.groupBy)==null?void 0:j.value)||"daily",purposeQuery:f.value.purposeQuery,pizzeriaIds:(L=f.value.pizzerias)==null?void 0:L.map(N=>N.id),contractorIds:i.value.map(N=>N.id)}},class:"text-decoration-none"},{default:x(()=>{var N;return[De(Q(se((N=y.data[`date-${s}`])==null?void 0:N.sum)),1)]}),_:2},1032,["to"])):(T(),K("span",Xe,"0.00"))],2),b("span",et,Q((E=y.data[`date-${s}`])!=null&&E.percentage_of_root?((P=y.data[`date-${s}`])==null?void 0:P.percentage_of_root)+"%":""),1)])]}),_:2},1032,["field"]))),128))]),_:1},8,["value"])]),a.value?(T(),I(ve,{key:0,color:"primary",size:"150px",class:"q-my-md"})):G("",!0)]),_:1})):G("",!0)}}};export{it as default};

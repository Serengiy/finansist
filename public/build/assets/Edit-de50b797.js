import{u as S,r as s,k as E,o as x,c as V,w as u,N as r,a as t,g as C,b as p,f as i,t as F,p as R,v as U,d as P,e as $,l as L,P as q}from"./app-b455ccb0.js";import{Q as M,a as O}from"./QTable-706bbcaa.js";import{a as b}from"./QSelect-0ac7f8bd.js";import{Q as j}from"./QForm-de778ffa.js";import{Q as z}from"./QPage-ca411f48.js";const H={class:"row justify-end"},A={class:"row q-mx-auto bg-white col-10 col-sm-8"},ee={__name:"Edit",setup(G){const w=S().params.id,c=s([]),g=s(!1),d=s(null),v=s([]),_=s([]),y=s(!1),m=s(!1),f=s([]),Q=s([{name:"sum",label:"Сумма",field:"sber_amountRub"},{name:"date",label:"Дата",field:"date_at"},{name:"payee_contractor",label:"Контрагент",field:"payee_contractor"},{name:"purpose",label:"Назначение платежа",field:"sber_paymentPurpose"}]),l=s({name:"",purpose_expression:""}),h=[{label:"DEBIT",value:"DEBIT"},{label:"CREDIT",value:"CREDIT"}],k=async()=>{try{const a=await axios.get(`/api/rules/${w}`,{params:{include:"category,contractor"}});l.value=a.data.data,d.value=l.value.category,v.value=l.value.contractor}catch{r.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},T=async()=>{q.show({message:"Загрузка..."});try{const a=await axios.get("/api/rules/operations-by-rule",{params:{rule:l.value}});f.value=a.data,m.value=!0}catch{r.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}finally{q.hide()}},B=async()=>{r.create({message:"Обработка началась",timeout:2e3});try{const a=await axios.get("/api/rules/validate-by-rule",{params:{rule:l.value}});f.value=a.data,r.create({message:"Обработка закончена",color:"green",timeout:2e3})}catch{r.create({message:"Ошибка при валидации",color:"red",timeout:2e3})}};E(async()=>{await k()});const D=async()=>{var a;try{const e=await axios.put(`/api/rules/${w}`,{category_id:d.value.id,operation_type:l.value.operation_type,purpose_expression:l.value.purpose_expression});(a=e==null?void 0:e.data)!=null&&a.success?r.create({message:"Данные успешно сохранены",color:"green",timeout:2e3}):r.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}catch{r.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}},I=async(a,e,o)=>{if((a==null?void 0:a.length)>4){g.value=!0;try{const n=await axios.get("/api/categories",{params:{q:a}});c.value=n.data.data,e(()=>c.value)}catch{r.create({message:"Fetching categories failed",color:"red"})}g.value=!1}},N=async(a,e,o)=>{if(a.length>3){y.value=!0;try{const n=await axios.get("/api/contractors",{params:{q:a}});_.value=n.data.data,e(()=>c.value)}catch{r.create({message:"Ошибка получения контрагентов",color:"red"})}}y.value=!1};return(a,e)=>(x(),V(z,{class:"row shadow-3 bg-grey-2"},{default:u(()=>[t(R,{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=o=>m.value=o),maximized:""},{default:u(()=>[t(C,null,{default:u(()=>[p("div",H,[t(i,{onClick:e[0]||(e[0]=o=>m.value=!1),flat:"",round:"",icon:"close"})]),t(M,{title:"Найденные операции соответствующие правилу",rows:f.value,columns:Q.value,"row-key":"id","rows-per-page-options":[20,50]},{"body-cell-payee_contractor":u(o=>[t(O,{props:o},{default:u(()=>{var n;return[p("div",null,F(((n=o.row.payee_contractor)==null?void 0:n.full_name)||"Нет данных"),1)]}),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1},8,["modelValue"]),p("div",A,[t(C,{class:"bg-white q-px-xl blue col-12"},{default:u(()=>[t(i,{class:"q-my-md",icon:"arrow_back",to:"/operations/rules"},{default:u(()=>e[6]||(e[6]=[U("Назад")])),_:1}),e[7]||(e[7]=p("div",{class:"text-h4"}," Редактирование правила ",-1)),t(j,{class:"q-mt-xl",onSubmit:P(D,["prevent"])},{default:u(()=>[t(b,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=o=>d.value=o),options:c.value,label:"Выберите категорию","option-value":"id","option-label":"name","use-input":"","input-debounce":"300",hint:"Start typing to search",onFilter:I,loading:g.value},null,8,["modelValue","options","loading"]),t(b,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:l.value.operation_type,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.operation_type=o),options:h,label:"Тип операции"},null,8,["modelValue"]),t($,{"model-value":"name",label:"Регулярное выражение назначения",class:"col-3 q-mt-md",outlined:"",dense:"",modelValue:l.value.purpose_expression,"onUpdate:modelValue":e[4]||(e[4]=o=>l.value.purpose_expression=o),filled:""},null,8,["modelValue"]),t(b,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:v.value,"onUpdate:modelValue":e[5]||(e[5]=o=>v.value=o),options:_.value,label:"Выберете контрагентов","option-value":"id","option-label":"name","use-input":"",multiple:"","input-debounce":"300",onFilter:N,loading:y.value},null,8,["modelValue","options","loading"]),t(i,{class:"q-mt-md",label:"Сохранить",type:"submit",color:"primary"}),t(i,{class:"q-ml-md q-mt-md",label:"Показать соответствующие операции",onClick:T,color:"primary"}),l.value.id?(x(),V(i,{key:0,class:"q-ml-md q-mt-md",label:"Провести привязку",onClick:B,color:"primary"})):L("",!0)]),_:1})]),_:1})])]),_:1}))}};export{ee as default};

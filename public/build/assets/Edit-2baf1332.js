import{Q as N,a as S}from"./QTable-0ef712a6.js";import{u as E,r as s,k as F,o as x,c as V,w as n,N as u,a as t,g as q,b,t as R,p as U,f as p,v as L,d as M,e as O,l as P}from"./app-02268028.js";import{a as f}from"./QSelect-ef7ff1d7.js";import{Q as $}from"./QForm-993dace1.js";import{Q as H}from"./QPage-8747372c.js";const j={class:"row q-mx-auto bg-white col-10 col-sm-8"},Y={__name:"Edit",setup(z){const _=E().params.id,i=s([]),m=s(!1),c=s(null),g=s([]),w=s([]),v=s(!1),d=s(!1),y=s([]),C=s([{name:"sum",label:"Сумма",field:"sber_amountRub"},{name:"date",label:"Дата",field:"date_at"},{name:"payee_contractor",label:"Контрагент",field:"payee_contractor"},{name:"purpose",label:"Назначение платежа",field:"sber_paymentPurpose"}]),l=s({name:"",purpose_expression:""}),Q=[{label:"DEBIT",value:"DEBIT"},{label:"CREDIT",value:"CREDIT"}],h=async()=>{try{const a=await axios.get(`/api/rules/${_}`,{params:{include:"category,contractor"}});l.value=a.data.data,c.value=l.value.category,g.value=l.value.contractor}catch{u.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},k=async()=>{try{const a=await axios.get("/api/rules/operations-by-rule",{params:{rule:l.value}});y.value=a.data,d.value=!0}catch{u.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},T=async()=>{try{const a=await axios.get("/api/rules/validate-by-rule",{params:{rule:l.value}});y.value=a.data,d.value=!0}catch{u.create({message:"Ошибка при валидации",color:"red",timeout:2e3})}};F(async()=>{await h()});const B=async()=>{var a;try{const e=await axios.put(`/api/rules/${_}`,{category_id:c.value.id,operation_type:l.value.operation_type,purpose_expression:l.value.purpose_expression});(a=e==null?void 0:e.data)!=null&&a.success?u.create({message:"Данные успешно сохранены",color:"green",timeout:2e3}):u.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}catch{u.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}},D=async(a,e,o)=>{if((a==null?void 0:a.length)>4){m.value=!0;try{const r=await axios.get("/api/categories",{params:{q:a}});i.value=r.data.data,e(()=>i.value)}catch{u.create({message:"Fetching categories failed",color:"red"})}m.value=!1}},I=async(a,e,o)=>{if(a.length>3){v.value=!0;try{const r=await axios.get("/api/contractors",{params:{q:a}});w.value=r.data.data,e(()=>i.value)}catch{u.create({message:"Ошибка получения контрагентов",color:"red"})}}v.value=!1};return(a,e)=>(x(),V(H,{class:"row shadow-3 bg-grey-2"},{default:n(()=>[t(U,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=o=>d.value=o)},{default:n(()=>[t(q,null,{default:n(()=>[t(N,{title:"Найденные операции соответствующие правилу",rows:y.value,columns:C.value,"row-key":"id"},{"body-cell-payee_contractor":n(o=>[t(S,{props:o},{default:n(()=>{var r;return[b("div",null,R(((r=o.row.payee_contractor)==null?void 0:r.full_name)||"Нет данных"),1)]}),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1},8,["modelValue"]),b("div",j,[t(q,{class:"bg-white q-px-xl blue col-12"},{default:n(()=>[t(p,{class:"q-my-md",icon:"arrow_back",to:"/operations/rules"},{default:n(()=>e[5]||(e[5]=[L("Назад")])),_:1}),e[6]||(e[6]=b("div",{class:"text-h4"}," Редактирование правила ",-1)),t($,{class:"q-mt-xl",onSubmit:M(B,["prevent"])},{default:n(()=>[t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:c.value,"onUpdate:modelValue":e[1]||(e[1]=o=>c.value=o),options:i.value,label:"Выберите категорию","option-value":"id","option-label":"name","use-input":"","input-debounce":"300",hint:"Start typing to search",onFilter:D,loading:m.value},null,8,["modelValue","options","loading"]),t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:l.value.operation_type,"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.operation_type=o),options:Q,label:"Тип операции"},null,8,["modelValue"]),t(O,{"model-value":"name",label:"Регулярное выражение назначения",class:"col-3 q-mt-md",outlined:"",dense:"",modelValue:l.value.purpose_expression,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.purpose_expression=o),filled:""},null,8,["modelValue"]),t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:g.value,"onUpdate:modelValue":e[4]||(e[4]=o=>g.value=o),options:w.value,label:"Выберете контрагентов","option-value":"id","option-label":"name","use-input":"",multiple:"","input-debounce":"300",onFilter:I,loading:v.value},null,8,["modelValue","options","loading"]),t(p,{class:"q-mt-md",label:"Сохранить",type:"submit",color:"primary"}),t(p,{class:"q-ml-md q-mt-md",label:"Показать соответствующие операции",onClick:k,color:"primary"}),l.value.id?(x(),V(p,{key:0,class:"q-ml-md q-mt-md",label:"Провести привязку",onClick:T,color:"primary"})):P("",!0)]),_:1})]),_:1})])]),_:1}))}};export{Y as default};

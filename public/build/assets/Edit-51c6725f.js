import{Q as S,a as E}from"./QTable-ef0cbfaf.js";import{u as F,r as s,k as R,o as x,c as V,w as u,N as r,a as t,g as q,b,t as U,p as P,f as m,v as L,d as M,e as O,l as $,P as C}from"./app-6f07ec69.js";import{a as f}from"./QSelect-dcda27dd.js";import{Q as H}from"./QForm-4051ce38.js";import{Q as j}from"./QPage-6bbc0b47.js";const z={class:"row q-mx-auto bg-white col-10 col-sm-8"},Z={__name:"Edit",setup(A){const _=F().params.id,i=s([]),p=s(!1),c=s(null),g=s([]),w=s([]),v=s(!1),d=s(!1),y=s([]),Q=s([{name:"sum",label:"Сумма",field:"sber_amountRub"},{name:"date",label:"Дата",field:"date_at"},{name:"payee_contractor",label:"Контрагент",field:"payee_contractor"},{name:"purpose",label:"Назначение платежа",field:"sber_paymentPurpose"}]),l=s({name:"",purpose_expression:""}),h=[{label:"DEBIT",value:"DEBIT"},{label:"CREDIT",value:"CREDIT"}],k=async()=>{try{const a=await axios.get(`/api/rules/${_}`,{params:{include:"category,contractor"}});l.value=a.data.data,c.value=l.value.category,g.value=l.value.contractor}catch{r.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},T=async()=>{C.show({message:"Загрузка..."});try{const a=await axios.get("/api/rules/operations-by-rule",{params:{rule:l.value}});y.value=a.data,d.value=!0}catch{r.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}finally{C.hide()}},B=async()=>{r.create({message:"Обработка началась",timeout:2e3});try{const a=await axios.get("/api/rules/validate-by-rule",{params:{rule:l.value}});y.value=a.data,d.value=!0,r.create({message:"Обработка закончена",color:"green",timeout:2e3})}catch{r.create({message:"Ошибка при валидации",color:"red",timeout:2e3})}};R(async()=>{await k()});const D=async()=>{var a;try{const e=await axios.put(`/api/rules/${_}`,{category_id:c.value.id,operation_type:l.value.operation_type,purpose_expression:l.value.purpose_expression});(a=e==null?void 0:e.data)!=null&&a.success?r.create({message:"Данные успешно сохранены",color:"green",timeout:2e3}):r.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}catch{r.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}},I=async(a,e,o)=>{if((a==null?void 0:a.length)>4){p.value=!0;try{const n=await axios.get("/api/categories",{params:{q:a}});i.value=n.data.data,e(()=>i.value)}catch{r.create({message:"Fetching categories failed",color:"red"})}p.value=!1}},N=async(a,e,o)=>{if(a.length>3){v.value=!0;try{const n=await axios.get("/api/contractors",{params:{q:a}});w.value=n.data.data,e(()=>i.value)}catch{r.create({message:"Ошибка получения контрагентов",color:"red"})}}v.value=!1};return(a,e)=>(x(),V(j,{class:"row shadow-3 bg-grey-2"},{default:u(()=>[t(P,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=o=>d.value=o)},{default:u(()=>[t(q,null,{default:u(()=>[t(S,{title:"Найденные операции соответствующие правилу",rows:y.value,columns:Q.value,"row-key":"id"},{"body-cell-payee_contractor":u(o=>[t(E,{props:o},{default:u(()=>{var n;return[b("div",null,U(((n=o.row.payee_contractor)==null?void 0:n.full_name)||"Нет данных"),1)]}),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1},8,["modelValue"]),b("div",z,[t(q,{class:"bg-white q-px-xl blue col-12"},{default:u(()=>[t(m,{class:"q-my-md",icon:"arrow_back",to:"/operations/rules"},{default:u(()=>e[5]||(e[5]=[L("Назад")])),_:1}),e[6]||(e[6]=b("div",{class:"text-h4"}," Редактирование правила ",-1)),t(H,{class:"q-mt-xl",onSubmit:M(D,["prevent"])},{default:u(()=>[t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:c.value,"onUpdate:modelValue":e[1]||(e[1]=o=>c.value=o),options:i.value,label:"Выберите категорию","option-value":"id","option-label":"name","use-input":"","input-debounce":"300",hint:"Start typing to search",onFilter:I,loading:p.value},null,8,["modelValue","options","loading"]),t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:l.value.operation_type,"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.operation_type=o),options:h,label:"Тип операции"},null,8,["modelValue"]),t(O,{"model-value":"name",label:"Регулярное выражение назначения",class:"col-3 q-mt-md",outlined:"",dense:"",modelValue:l.value.purpose_expression,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.purpose_expression=o),filled:""},null,8,["modelValue"]),t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:g.value,"onUpdate:modelValue":e[4]||(e[4]=o=>g.value=o),options:w.value,label:"Выберете контрагентов","option-value":"id","option-label":"name","use-input":"",multiple:"","input-debounce":"300",onFilter:N,loading:v.value},null,8,["modelValue","options","loading"]),t(m,{class:"q-mt-md",label:"Сохранить",type:"submit",color:"primary"}),t(m,{class:"q-ml-md q-mt-md",label:"Показать соответствующие операции",onClick:T,color:"primary"}),l.value.id?(x(),V(m,{key:0,class:"q-ml-md q-mt-md",label:"Провести привязку",onClick:B,color:"primary"})):$("",!0)]),_:1})]),_:1})])]),_:1}))}};export{Z as default};

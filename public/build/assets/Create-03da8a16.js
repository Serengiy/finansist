import{Q as k,a as I}from"./QTable-a15a0b59.js";import{r as t,o as N,c as S,w as n,a as o,g as q,b as f,t as U,p as E,f as g,v as F,d as R,e as h,N as u}from"./app-b4d0562f.js";import{a as y}from"./QSelect-90512f16.js";import{Q as L}from"./QForm-d354ba5e.js";import{Q as P}from"./QPage-ee055e33.js";const H={class:"row q-mx-auto bg-white col-10 col-sm-8"},K={__name:"Create",setup(M){var x;const d=t([]),_=t([]),V=[{label:"DEBIT",value:"DEBIT"},{label:"CREDIT",value:"CREDIT"}],c=t(!1),p=t(!1),m=t([]),i=t(null),v=t(V[0]),b=t(!1),w=t([]),C=t([{name:"sum",label:"Сумма",field:"sber_amountRub"},{name:"date",label:"Дата",field:"date_at"},{name:"payee_contractor",label:"Контрагент",field:"payee_contractor"},{name:"purpose",label:"Назначение платежа",field:"sber_paymentPurpose"}]),s=t({purpose_expression:"",operation_type:(x=v==null?void 0:v.value)==null?void 0:x.value}),Q=async()=>{var l;s.value.contractor_ids=m.value.map(e=>e.id),s.value.category_id=(l=i==null?void 0:i.value)==null?void 0:l.id;try{(await axios.post("/api/rules",s.value)).data.success?u.create({message:"Правило успешно создано",color:"green"}):u.create({message:"Правило не создано",color:"red"})}catch{u.create({message:"Ошибка создания правила",color:"red"})}},B=async(l,e,a)=>{if(l.length>3){c.value=!0;try{const r=await axios.get("/api/categories",{params:{q:l}});d.value=r.data.data,e(()=>d.value)}catch{u.create({message:"Ошибка получения категорий",color:"red"})}c.value=!1}},D=async(l,e,a)=>{if(l.length>3){p.value=!0;try{const r=await axios.get("/api/contractors",{params:{q:l}});_.value=r.data.data,e(()=>d.value)}catch{u.create({message:"Ошибка получения контрагентов",color:"red"})}}p.value=!1},T=async()=>{try{const l=await axios.get("/api/rules/operations-by-rule",{params:{rule:s.value}});w.value=l.data,b.value=!0}catch(l){console.log(l),u.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}};return(l,e)=>(N(),S(P,{class:"row shadow-3 bg-grey-2"},{default:n(()=>[o(E,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=a=>b.value=a)},{default:n(()=>[o(q,null,{default:n(()=>[o(k,{title:"Найденные операции соответствующие правилу",rows:w.value,columns:C.value,"row-key":"id"},{"body-cell-payee_contractor":n(a=>[o(I,{props:a},{default:n(()=>{var r;return[f("div",null,U(((r=a.row.payee_contractor)==null?void 0:r.full_name)||"Нет данных"),1)]}),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1},8,["modelValue"]),f("div",H,[o(q,{class:"bg-white q-px-xl blue col-12"},{default:n(()=>[o(g,{class:"q-my-md",icon:"arrow_back",to:"/operations/rules"},{default:n(()=>e[5]||(e[5]=[F("Назад")])),_:1}),e[6]||(e[6]=f("div",{class:"text-h4 q-mt-md"}," Создание правила ",-1)),o(L,{class:"q-mt-xl",onSubmit:R(Q,["prevent"])},{default:n(()=>[o(y,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:i.value,"onUpdate:modelValue":e[1]||(e[1]=a=>i.value=a),options:d.value,label:"Выберите категорию","option-value":"id","option-label":"name","use-input":"","input-debounce":"300",onFilter:B,loading:c.value},null,8,["modelValue","options","loading"]),o(h,{"model-value":"name",label:"Регулярное выражение назначения",class:"col-3 q-mt-md",outlined:"",dense:"",modelValue:s.value.purpose_expression,"onUpdate:modelValue":e[2]||(e[2]=a=>s.value.purpose_expression=a),filled:""},null,8,["modelValue"]),o(y,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"","option-value":"value","option-label":"label","emit-value":"",modelValue:s.value.operation_type,"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.operation_type=a),options:V,label:"Тип операции"},null,8,["modelValue"]),o(y,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=a=>m.value=a),options:_.value,label:"Выберете контрагентов","option-value":"id","option-label":"name","use-input":"",multiple:"","input-debounce":"300",onFilter:D,loading:p.value},null,8,["modelValue","options","loading"]),o(g,{class:"q-mt-md",label:"Создать",type:"submit",color:"primary"}),o(g,{class:"q-ml-md q-mt-md",label:"Показать соответствующие операции",onClick:T,color:"primary"})]),_:1})]),_:1})])]),_:1}))}};export{K as default};

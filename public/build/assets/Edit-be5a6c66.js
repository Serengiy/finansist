import{Q as D,a as k}from"./QTable-2b5d2408.js";import{u as I,r as s,k as R,o as S,c as E,w as n,N as u,a as t,g as x,b as y,t as F,R as N,f as v,s as U,d as L,e as M}from"./app-4df6b152.js";import{a as f}from"./QSelect-995ec182.js";import{Q as P}from"./QForm-a72fcf24.js";import{Q as $}from"./QPage-b9f7ef16.js";const H={class:"row q-mx-auto bg-white col-10 col-sm-8"},W={__name:"Edit",setup(O){const b=I().params.id,i=s([]),d=s(!1),c=s(null),p=s([]),_=s([]),m=s(!1),g=s(!1),w=s([]),V=s([{name:"sum",label:"Сумма",field:"sber_amountRub"},{name:"date",label:"Дата",field:"date_at"},{name:"payee_contractor",label:"Контрагент",field:"payee_contractor"},{name:"purpose",label:"Назначение платежа",field:"sber_paymentPurpose"}]),l=s({name:"",purpose_expression:""}),q=[{label:"DEBIT",value:"DEBIT"},{label:"CREDIT",value:"CREDIT"}],C=async()=>{try{const a=await axios.get(`/api/rules/${b}`,{params:{include:"category,contractor"}});l.value=a.data.data,c.value=l.value.category,p.value=l.value.contractor}catch{u.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},Q=async()=>{try{const a=await axios.get("/api/rules/operations-by-rule",{params:{rule:l.value}});w.value=a.data,g.value=!0}catch{u.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}};R(async()=>{await C()});const T=async()=>{var a;try{const e=await axios.put(`/api/rules/${b}`,{category_id:c.value.id,operation_type:l.value.operation_type,purpose_expression:l.value.purpose_expression});(a=e==null?void 0:e.data)!=null&&a.success?u.create({message:"Данные успешно сохранены",color:"green",timeout:2e3}):u.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}catch{u.create({message:"Ошибка сохранения данных",color:"red",timeout:2e3})}},h=async(a,e,o)=>{if((a==null?void 0:a.length)>4){d.value=!0;try{const r=await axios.get("/api/categories",{params:{q:a}});i.value=r.data.data,e(()=>i.value)}catch{u.create({message:"Fetching categories failed",color:"red"})}d.value=!1}},B=async(a,e,o)=>{if(a.length>3){m.value=!0;try{const r=await axios.get("/api/contractors",{params:{q:a}});_.value=r.data.data,e(()=>i.value)}catch{u.create({message:"Ошибка получения контрагентов",color:"red"})}}m.value=!1};return(a,e)=>(S(),E($,{class:"row shadow-3 bg-grey-2"},{default:n(()=>[t(N,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=o=>g.value=o)},{default:n(()=>[t(x,null,{default:n(()=>[t(D,{title:"Найденные операции соответствующие правилу",rows:w.value,columns:V.value,"row-key":"id"},{"body-cell-payee_contractor":n(o=>[t(k,{props:o},{default:n(()=>{var r;return[y("div",null,F(((r=o.row.payee_contractor)==null?void 0:r.full_name)||"Нет данных"),1)]}),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1},8,["modelValue"]),y("div",H,[t(x,{class:"bg-white q-px-xl blue col-12"},{default:n(()=>[t(v,{class:"q-my-md",icon:"arrow_back",to:"/operations/rules"},{default:n(()=>e[5]||(e[5]=[U("Назад")])),_:1}),e[6]||(e[6]=y("div",{class:"text-h4"}," Редактирование правила ",-1)),t(P,{class:"q-mt-xl",onSubmit:L(T,["prevent"])},{default:n(()=>[t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:c.value,"onUpdate:modelValue":e[1]||(e[1]=o=>c.value=o),options:i.value,label:"Выберите категорию","option-value":"id","option-label":"name","use-input":"","input-debounce":"300",hint:"Start typing to search",onFilter:h,loading:d.value},null,8,["modelValue","options","loading"]),t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:l.value.operation_type,"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.operation_type=o),options:q,label:"Тип операции"},null,8,["modelValue"]),t(M,{"model-value":"name",label:"Регулярное выражение назначения",class:"col-3 q-mt-md",outlined:"",dense:"",modelValue:l.value.purpose_expression,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.purpose_expression=o),filled:""},null,8,["modelValue"]),t(f,{class:"col-3 q-mt-md",dense:"",clearable:"",outlined:"",filled:"",modelValue:p.value,"onUpdate:modelValue":e[4]||(e[4]=o=>p.value=o),options:_.value,label:"Выберете контрагентов","option-value":"id","option-label":"name","use-input":"",multiple:"","input-debounce":"300",onFilter:B,loading:m.value},null,8,["modelValue","options","loading"]),t(v,{class:"q-mt-md",label:"Сохранить",type:"submit",color:"primary"}),t(v,{class:"q-ml-md q-mt-md",label:"Показать соответствующие операции",onClick:Q,color:"primary"})]),_:1})]),_:1})])]),_:1}))}};export{W as default};

import{r as u,o as S,P,b as p,c as A,d as v,f as C,N as d,h as l,g as n,j as O,Q as x,k as $,l as q,e as z,m as G,t as g,F as H,i as J,n as K}from"./app-709df95d.js";import{Q as f}from"./QSelect-38babbb6.js";import{Q as W,a as X}from"./QTable-b060046c.js";import{Q as Y}from"./QForm-b214abb1.js";import{Q as Z}from"./QPage-aa58c21f.js";const ee={class:"row q-mx-auto bg-white col-10 col-sm-8"},te={class:"row items-center justify-between"},oe={class:"col-9"},le={class:"row items-center justify-between q-mt-sm"},ae={class:"col-4"},se={class:"col-5 text-right"},ne={class:"row items-center justify-between q-mt-sm"},re={class:"col-9 full-height"},ie={class:"row items-center justify-between q-mt-sm"},ue={class:"col-9 full-height"},de={class:"row items-center justify-between q-mt-sm"},ce={class:"col-9 full-height"},me={class:"row items-center justify-between q-mt-sm"},pe={class:"col-9"},ve={class:"row items-center justify-between q-mt-sm"},ge={class:"col-9"},fe={class:"row items-center justify-between q-mt-sm"},be={class:"col-9"},ye={key:0},we={key:1,style:{"min-width":"65px"}},_e={class:"row"},he={class:"row col-3 justify-end"},Ve={class:"row col-3 justify-end"},Ce={key:0,class:"row justify-between"},xe={class:"text-red-8 row col-8 justify-center"},qe={class:"col-4 row justify-center"},Re={__name:"Create",setup(ze){const F=u([]),b=u([]),j=u([]),y=u(!1),c=u([]),w=u({message:"",difference:""}),t=u({pizzeria:null,sber_amountRub:"",description:"",is_completed:!1,date_at:"",direction:null,contractorPayer:null,contractorPayee:null,categories:[]}),U=a=>{const s=a.replace(/,/g,".").replace(/[^\d.-]/g,"");if(/^-?\d*\.?\d*$/.test(s)){const r=parseFloat(s);t.value.amount=isNaN(r)?"":r}else t.value.amount=""},R=()=>{U(t.value.amount)},k=async()=>{try{const a=await C.get("/api/pizzerias");j.value=a.data.data}catch{d.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},N=async()=>{try{const a=await C.get("/api/categories");F.value=a.data.data,b.value=a.data.data}catch{d.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},I=async(a,e="")=>{try{const s=await C.get("/api/contractors",{params:{q:a||"",id:e}});c.value=s.data.data}catch{d.create({message:"Ошибка получения контрагентов",color:"red",timeout:2e3})}finally{y.value=!1}},Q=async(a,e)=>{a.length>4?(y.value=!0,await I(a),e(()=>c.value)):(c.value=[],e(()=>c.value))},B=async()=>{var e,s,o,r,i,_,h;const a=t.value.categories.reduce((m,V)=>m+(parseFloat(V.amount)||0),0);if(t.value.categories.length&&a!==parseFloat(t.value.sber_amountRub)){d.create({message:"Сумма категорий не равна сумме операции",color:"red"});return}try{t.value.pizzeria_id=(s=(e=t.value)==null?void 0:e.pizzeria)==null?void 0:s.id;const m=await C.post("/api/operations",{...t.value,payer_contractor_id:(r=(o=t.value)==null?void 0:o.contractorPayer)==null?void 0:r.id,payee_contractor_id:(_=(i=t.value)==null?void 0:i.contractorPayee)==null?void 0:_.id,sber_paymentPurpose:t.value.description,sber_direction:(h=t.value.direction)==null?void 0:h.value,categories:t.value.categories.map(V=>({id:V.category.id,sber_amountRub:V.amount}))});m.data.success&&(d.create({message:"Операция успешно создана",color:"positive"}),t.value={pizzeria:null,sber_amountRub:"",description:"",is_completed:!1,date:"",contractor:null,categories:[]}),m.data.success||d.create({message:m.data.message,color:"red"})}catch{d.create({message:"Ошибка отправки данных",color:"red"})}},D=(a,e)=>{const s=t.value.categories.reduce((_,h)=>_+(parseFloat(h.amount)||0),0),o=parseFloat(t.value.sber_amountRub)-s,r=parseFloat(e.row.amount)/parseFloat(t.value.sber_amountRub)*100;e.row.percent=r.toFixed(2);let i="";o<s?i="Уменьшите сумму на: ":o>s&&(i="Увеличьте сумму на: "),w.value={message:i,difference:Math.abs(o)}},T=(a,e)=>{if(a==="")e(()=>{b.value=[...F.value]});else{const s=a.toLowerCase();e(()=>{b.value=F.value.filter(o=>o.name.toLowerCase().includes(s))})}};function E(a){console.log(a.id),t.value.categories=t.value.categories.filter(e=>(e==null?void 0:e.category)!==null)}const L=u([{name:"category",label:"Категория",align:"left"},{name:"amount",label:"Сумма",align:"left",style:"width: 100px"},{name:"percent",label:"Доля",align:"left",width:"50px"}]),M=()=>{t.value.categories.push({category:"",amount:0,percent:0})};return S(()=>{P.show(),k(),N(),P.hide()}),(a,e)=>(p(),A(Z,{class:"row shadow-3 bg-grey-2"},{default:v(()=>[l("div",ee,[n(K,{class:"bg-white q-px-xl blue col-12"},{default:v(()=>[e[17]||(e[17]=l("div",{class:"text-h4 q-mt-md"}," Редактирование операции ",-1)),n(Y,{class:"q-mt-xl",onSubmit:O(B,["prevent"])},{default:v(()=>{var s;return[l("div",te,[e[8]||(e[8]=l("div",{class:"col-2 full-height"}," Сумма: ",-1)),l("div",oe,[n(x,{dense:"",outlined:"",modelValue:t.value.sber_amountRub,"onUpdate:modelValue":e[0]||(e[0]=o=>t.value.sber_amountRub=o),label:"Сумма",type:"number",required:"",onInput:R},null,8,["modelValue"])])]),l("div",le,[e[9]||(e[9]=l("div",{class:"col-3 full-height"}," Дата: ",-1)),l("div",ae,[n(x,{dense:"",outlined:"",modelValue:t.value.date_at,"onUpdate:modelValue":e[1]||(e[1]=o=>t.value.date_at=o),label:"Date",type:"date",required:""},null,8,["modelValue"])]),l("div",se,[n($,{dense:"",outlined:"",modelValue:t.value.is_completed,"onUpdate:modelValue":e[2]||(e[2]=o=>t.value.is_completed=o),label:"Подтвердить операцию"},null,8,["modelValue"])])]),l("div",ne,[e[10]||(e[10]=l("div",{class:"col-3 full-height"}," Пиццерия: ",-1)),l("div",re,[n(f,{class:"col-3",dense:"",clearable:"",outlined:"",filled:"",modelValue:t.value.pizzeria,"onUpdate:modelValue":e[3]||(e[3]=o=>t.value.pizzeria=o),options:j.value,label:"Пиццерия","option-value":"id","option-label":"name",required:""},null,8,["modelValue","options"])])]),l("div",ie,[e[11]||(e[11]=l("div",{class:"col-3 full-height"}," Контрагент (payer): ",-1)),l("div",ue,[n(f,{class:"col-6",dense:"",outlined:"",filled:"",label:"Контрагент",modelValue:t.value.contractorPayer,"onUpdate:modelValue":e[4]||(e[4]=o=>t.value.contractorPayer=o),options:c.value,"use-input":"",clearable:"","option-label":"name",onFilter:Q,loading:y.value},null,8,["modelValue","options","loading"])])]),l("div",de,[e[12]||(e[12]=l("div",{class:"col-3 full-height"}," Контрагент (payee): ",-1)),l("div",ce,[n(f,{class:"col-6",dense:"",outlined:"",filled:"",label:"Контрагент",modelValue:t.value.contractorPayee,"onUpdate:modelValue":e[5]||(e[5]=o=>t.value.contractorPayee=o),options:c.value,"use-input":"",clearable:"","option-label":"name",onFilter:Q,loading:y.value},null,8,["modelValue","options","loading"])])]),l("div",me,[e[13]||(e[13]=l("div",{class:"col-2 full-height"}," Direction: ",-1)),l("div",pe,[n(f,{dense:"",outlined:"",required:"",filled:"",label:"Тип операции",modelValue:t.value.direction,"onUpdate:modelValue":e[6]||(e[6]=o=>t.value.direction=o),options:[{label:"Поступление (debit)",value:"DEBIT"},{label:"Выплата (credit)",value:"CREDIT"}]},null,8,["modelValue"])])]),l("div",ve,[e[14]||(e[14]=l("div",{class:"col-2 full-height"}," Назначение: ",-1)),l("div",ge,[n(x,{type:"textarea",dense:"",outlined:"",modelValue:t.value.description,"onUpdate:modelValue":e[7]||(e[7]=o=>t.value.description=o),label:"Назначение",required:""},null,8,["modelValue"])])]),l("div",fe,[e[16]||(e[16]=l("div",{class:"col-3 full-height"}," Категории: ",-1)),l("div",be,[n(W,{rows:t.value.categories,columns:L.value,flat:"",bordered:"",dense:"","hide-bottom":""},{"body-cell":v(o=>[n(X,{item:o},{default:v(()=>{var r;return[o.col.name==="category"?(p(),q("div",ye,[n(f,{dense:"",flat:"",modelValue:o.row.category,"onUpdate:modelValue":i=>o.row.category=i,options:b.value,"option-label":"name",clearable:"",borderless:"","use-input":"",onFilter:T,onClear:E},null,8,["modelValue","onUpdate:modelValue","options"])])):z("",!0),o.col.name==="amount"?(p(),q("div",we,[n(x,{onChange:i=>D(i,o),flat:"",borderless:"",modelValue:o.row.amount,"onUpdate:modelValue":i=>o.row.amount=i,dense:"",type:"number"},null,8,["onChange","modelValue","onUpdate:modelValue"])])):z("",!0),o.col.name==="percent"?(p(),q(H,{key:2},[G(g((r=o.row)==null?void 0:r.percent)+"% ",1)],64)):z("",!0)]}),_:2},1032,["item"])]),_:1},8,["rows","columns"]),l("div",_e,[l("div",{class:"row justify-between col-6"},[l("p",{onClick:M,class:"cursor-pointer text-blue-9"}," Добавить... "),e[15]||(e[15]=l("p",null," Итого: ",-1))]),l("div",he,[l("p",null,g(t.value.categories.reduce((o,r)=>o+(parseFloat(r.amount)||0),0)),1)]),l("div",Ve,[l("p",null,g((t.value.categories.reduce((o,r)=>o+(parseFloat(r.amount)||0),0)/t.value.sber_amountRub*100).toFixed(2))+"% ",1)])]),(s=w.value)!=null&&s.message?(p(),q("div",Ce,[l("div",xe,g(w.value.message),1),l("div",qe,g(w.value.difference),1)])):z("",!0)])]),n(J,{class:"q-mt-md",label:"Сохранить",type:"submit",color:"primary"})]}),_:1})]),_:1})])]),_:1}))}};export{Re as default};
